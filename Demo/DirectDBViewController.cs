// This file has been autogenerated from a class added in the UI designer.

using System;
using SQLite;
using Foundation;
using UIKit;
using System.Collections.Generic;
using System.Linq;

namespace Demo
{
	public partial class DirectDBViewController : UIViewController
	{
        static private int db_int;
        static private Person currentUser;
        List<DirectDebits> directs;
		public DirectDBViewController (IntPtr handle) : base (handle)
		{
		}
        public override void ViewDidLoad()
        {
            base.ViewDidLoad();

            Title = "Add Direct Debits";
            update(currentUser.Id);

            DirectDebit_Name.EditingDidEnd += DirectDebit_Name_EditingDidEnd;
            DirectDebit_Period.EditingDidEnd += DirectDebit_Period_EditingDidEnd;

            View.UserInteractionEnabled = true;
            View.AddGestureRecognizer(new UITapGestureRecognizer(() =>
            {
                this.View.EndEditing(true);
            }
            ));

            db_cost.EditingDidEnd += DirectDebit_Cost_EditingDidEnd;
            DirectDebit_Add.TouchDown += DirectDebit_Add_TouchDown;

            NavigationItem.RightBarButtonItem = new UIBarButtonItem(UIBarButtonSystemItem.Done, target: View, action: null);

            NavigationItem.RightBarButtonItem.Clicked += RightBarButtonItem_Clicked;
        }

        /// <summary>
        /// Shows direct debits added
        /// </summary>
        private void ShowDirect()
        {
            foreach(DirectDebits debit in directs)
            {
                if(debit.m_userID == currentUser.Id)
                {
                    DirectDebit_Show.Text = $"{debit.m_Name} added";
                    DirectDebit_Show.Text = "\r\n";
                }
                
            }
        }

        private void DirectDebit_Cost_EditingDidEnd(object sender, EventArgs e)
        {
            if (db_cost.Text.ToString() != string.Empty)
            {
                db_cost.BackgroundColor = UIColor.Green;
            }
        }

        /// <summary>
        /// Resets the state of all button once a new has inputed their direct debit
        /// </summary>
        public void refresh()
        {
            DirectDebit_Name.BackgroundColor = UIColor.Clear;
            DirectDebit_Name.Text = "";
            DirectDebit_Period.BackgroundColor = UIColor.Clear;
            DirectDebit_Period.Text = "";
            DirectDebit_Add.BackgroundColor = UIColor.Clear;
            db_cost.Text = "";
            db_cost.BackgroundColor = UIColor.Clear;
        }

        /// <summary>
        /// Calculates how much money will be deducted from the overall allowance the user has inputted
        /// </summary>
        private void Calculateexpense()
        {
            DateTime start = Convert.ToDateTime(currentUser.m_StartDate);
            DateTime end = Convert.ToDateTime(currentUser.m_EndDate);
            double days = (end - start).TotalDays;
            foreach(DirectDebits debit in directs)
            {
                if(debit.m_userID == currentUser.Id)
                {
                    int dates = (int)days / (int)debit.m_days;
                    double reg = dates * debit.m_cost;
                    using (SQLiteConnection connection = new SQLiteConnection(AppDelegate.FilePath))
                    {

                        //currentUser.m_Money;
                        currentUser.m_Money = currentUser.m_Money - (float)reg;
                        //float newnum = currentUser.m_Money - float.Parse(reg);
                        connection.Update(currentUser);

                    }
                }
            }
            //DateTime howmanyD = DateTime.Compare(start, end);
        }
        private void RightBarButtonItem_Clicked(object sender, EventArgs e)
        {
            Calculateexpense();
            NavigationController.PopToRootViewController(true);
        }

        private void DirectDebit_Add_TouchDown(object sender, EventArgs e)
        {
            DirectDebits directDebit = new DirectDebits
            {
                m_userID = currentUser.Id,
                m_days = int.Parse(DirectDebit_Period.Text.ToString()),
                m_Name = DirectDebit_Name.Text.ToString(),
                m_cost = float.Parse(db_cost.Text.ToString())
                
            };
            using (SQLiteConnection connection = new SQLiteConnection(AppDelegate.FilePath))
            {
                connection.Insert(directDebit);
                directs = connection.Table<DirectDebits>().ToList();
            }

            
            
            
            refresh();
            ShowDirect();
            //directs.RemoveRange(0, directs.Count);
        }

        private void DirectDebit_Period_EditingDidEnd(object sender, EventArgs e)
        {
            if(DirectDebit_Period.Text.ToString() != string.Empty)
            {
                DirectDebit_Period.BackgroundColor = UIColor.Green;
            }
            
        }

        private void DirectDebit_Name_EditingDidEnd(object sender, EventArgs e)
        {
            if (DirectDebit_Name.Text.ToString() != string.Empty)
            {
                DirectDebit_Name.BackgroundColor = UIColor.Green;
            }
        }

        /// <summary>
        /// returns what the int had been changed to
        /// </summary>
        /// <param name="selection"></param>
        /// <returns></returns>
        static public int update(int selection)
        {
            db_int = selection;
            return db_int;
        }
        static public void UserSelected(Person person)
        {
            currentUser = person;
        }
    }
}
